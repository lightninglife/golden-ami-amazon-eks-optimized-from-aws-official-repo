
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Build template and runtime resources for the Amazon EKS AMI">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../CHANGELOG/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.8">
    
    
      
        <title>User Guide - Amazon EKS AMI</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f2e4d321.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#user-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Amazon EKS AMI" class="md-header__button md-logo" aria-label="Amazon EKS AMI" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Amazon EKS AMI
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              User Guide
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/awslabs/amazon-eks-ami" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    awslabs/amazon-eks-ami
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Amazon EKS AMI" class="md-nav__button md-logo" aria-label="Amazon EKS AMI" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Amazon EKS AMI
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/awslabs/amazon-eks-ami" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    awslabs/amazon-eks-ami
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ami-template-variables" class="md-nav__link">
    <span class="md-ellipsis">
      AMI template variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#choosing-kubernetes-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing Kubernetes binaries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Choosing Kubernetes binaries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-latest-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Using the latest binaries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-specific-version-of-the-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Using a specific version of the binaries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#providing-your-own-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Providing your own binaries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#container-image-caching" class="md-nav__link">
    <span class="md-ellipsis">
      Container Image Caching
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iam-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      IAM Permissions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customizing-kubelet-config" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Kubelet Config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#al2-and-linux-kernel-information" class="md-nav__link">
    <span class="md-ellipsis">
      AL2 and Linux Kernel Information
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-known-instance-types" class="md-nav__link">
    <span class="md-ellipsis">
      Updating known instance types
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-locked-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Version-locked packages
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#image-credential-provider-plugins" class="md-nav__link">
    <span class="md-ellipsis">
      Image credential provider plugins
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ephemeral-storage" class="md-nav__link">
    <span class="md-ellipsis">
      Ephemeral Storage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ephemeral Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#raid-0-for-kubelet-and-containerd-raid0" class="md-nav__link">
    <span class="md-ellipsis">
      RAID-0 for Kubelet and Containerd (raid0)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mount-for-persistent-volumes-mount" class="md-nav__link">
    <span class="md-ellipsis">
      Mount for Persistent Volumes (mount)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../CHANGELOG/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Community
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Community
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CONTRIBUTING/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribution guidelines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../CODE_OF_CONDUCT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code of Conduct
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ami-template-variables" class="md-nav__link">
    <span class="md-ellipsis">
      AMI template variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#choosing-kubernetes-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing Kubernetes binaries
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Choosing Kubernetes binaries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-the-latest-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Using the latest binaries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-specific-version-of-the-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Using a specific version of the binaries
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#providing-your-own-binaries" class="md-nav__link">
    <span class="md-ellipsis">
      Providing your own binaries
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#container-image-caching" class="md-nav__link">
    <span class="md-ellipsis">
      Container Image Caching
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iam-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      IAM Permissions
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customizing-kubelet-config" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing Kubelet Config
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#al2-and-linux-kernel-information" class="md-nav__link">
    <span class="md-ellipsis">
      AL2 and Linux Kernel Information
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-known-instance-types" class="md-nav__link">
    <span class="md-ellipsis">
      Updating known instance types
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#version-locked-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Version-locked packages
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#image-credential-provider-plugins" class="md-nav__link">
    <span class="md-ellipsis">
      Image credential provider plugins
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ephemeral-storage" class="md-nav__link">
    <span class="md-ellipsis">
      Ephemeral Storage
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Ephemeral Storage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#raid-0-for-kubelet-and-containerd-raid0" class="md-nav__link">
    <span class="md-ellipsis">
      RAID-0 for Kubelet and Containerd (raid0)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mount-for-persistent-volumes-mount" class="md-nav__link">
    <span class="md-ellipsis">
      Mount for Persistent Volumes (mount)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="user-guide">User Guide</h1>
<p>This document includes details about using the AMI template and the resulting AMIs.</p>
<hr />
<h2 id="ami-template-variables">AMI template variables</h2>
<p>Default values for most variables are defined in <a href="https://github.com/awslabs/amazon-eks-ami/blob/master/eks-worker-al2-variables.json">a default variable file</a>.</p>
<p>Users have the following options for specifying their own values:</p>
<ol>
<li>Provide a variable file with the <code>PACKER_VARIABLE_FILE</code> argument to <code>make</code>. Values in this file will override values in the default variable file. Your variable file does not need to include all possible variables, as it will be merged with the default variable file.</li>
<li>Pass a key-value pair for any template variable to <code>make</code>. These values will override any values that were specified with the first method. In the table below, these variables have a default value of <em>None</em>.</li>
</ol>
<blockquote>
<p><strong>Note</strong>
Some variables (such as <code>arch</code> and <code>kubernetes_version</code>) do not have a sensible, static default, and are satisfied by the Makefile.
Such variables do not appear in the default variable file, and must be overridden (if necessary) by the second method described above.</p>
</blockquote>
<!-- this table is generated by hack/generate-template-variable-doc.sh -->
<!-- template-variable-table-boundary -->
<table>
<thead>
<tr>
<th>Variable</th>
<th>Default value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>additional_yum_repos</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>ami_component_description</code></td>
<td><code>(k8s: {{ user `kubernetes_version` }}, docker: {{ user `docker_version` }}, containerd: {{ user `containerd_version` }})</code></td>
<td></td>
</tr>
<tr>
<td><code>ami_description</code></td>
<td><code>EKS Kubernetes Worker AMI with AmazonLinux2 image</code></td>
<td></td>
</tr>
<tr>
<td><code>ami_name</code></td>
<td><em>None</em></td>
<td></td>
</tr>
<tr>
<td><code>ami_regions</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>ami_users</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>arch</code></td>
<td><em>None</em></td>
<td></td>
</tr>
<tr>
<td><code>associate_public_ip_address</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>aws_access_key_id</code></td>
<td><code>{{env `AWS_ACCESS_KEY_ID`}}</code></td>
<td></td>
</tr>
<tr>
<td><code>aws_region</code></td>
<td><code>us-west-2</code></td>
<td></td>
</tr>
<tr>
<td><code>aws_secret_access_key</code></td>
<td><code>{{env `AWS_SECRET_ACCESS_KEY`}}</code></td>
<td></td>
</tr>
<tr>
<td><code>aws_session_token</code></td>
<td><code>{{env `AWS_SESSION_TOKEN`}}</code></td>
<td></td>
</tr>
<tr>
<td><code>binary_bucket_name</code></td>
<td><code>amazon-eks</code></td>
<td></td>
</tr>
<tr>
<td><code>binary_bucket_region</code></td>
<td><code>us-west-2</code></td>
<td></td>
</tr>
<tr>
<td><code>cache_container_images</code></td>
<td><code>false</code></td>
<td></td>
</tr>
<tr>
<td><code>cni_plugin_version</code></td>
<td><code>v1.2.0</code></td>
<td></td>
</tr>
<tr>
<td><code>containerd_version</code></td>
<td><code>1.7.*</code></td>
<td></td>
</tr>
<tr>
<td><code>creator</code></td>
<td><code>{{env `USER`}}</code></td>
<td></td>
</tr>
<tr>
<td><code>docker_version</code></td>
<td><code>20.10.*</code></td>
<td></td>
</tr>
<tr>
<td><code>encrypted</code></td>
<td><code>false</code></td>
<td></td>
</tr>
<tr>
<td><code>enable_fips</code></td>
<td><code>false</code></td>
<td>Install openssl and enable fips related kernel parameters</td>
</tr>
<tr>
<td><code>instance_type</code></td>
<td><em>None</em></td>
<td></td>
</tr>
<tr>
<td><code>kernel_version</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>kms_key_id</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>kubernetes_build_date</code></td>
<td><em>None</em></td>
<td></td>
</tr>
<tr>
<td><code>kubernetes_version</code></td>
<td><em>None</em></td>
<td></td>
</tr>
<tr>
<td><code>launch_block_device_mappings_volume_size</code></td>
<td><code>4</code></td>
<td></td>
</tr>
<tr>
<td><code>pause_container_version</code></td>
<td><code>3.5</code></td>
<td></td>
</tr>
<tr>
<td><code>pull_cni_from_github</code></td>
<td><code>true</code></td>
<td></td>
</tr>
<tr>
<td><code>remote_folder</code></td>
<td><code>/tmp</code></td>
<td>Directory path for shell provisioner scripts on the builder instance</td>
</tr>
<tr>
<td><code>runc_version</code></td>
<td><code>1.1.*</code></td>
<td></td>
</tr>
<tr>
<td><code>security_group_id</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>source_ami_filter_name</code></td>
<td><code>amzn2-ami-minimal-hvm-*</code></td>
<td></td>
</tr>
<tr>
<td><code>source_ami_id</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>source_ami_owners</code></td>
<td><code>137112412989</code></td>
<td></td>
</tr>
<tr>
<td><code>ssh_interface</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>ssh_username</code></td>
<td><code>ec2-user</code></td>
<td></td>
</tr>
<tr>
<td><code>ssm_agent_version</code></td>
<td><code>""</code></td>
<td>Version of the SSM agent to install from the S3 bucket provided by the SSM agent project, such as <code>latest</code>. If empty, the latest version of the SSM agent available in the Amazon Linux core repositories will be installed.</td>
</tr>
<tr>
<td><code>subnet_id</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>temporary_security_group_source_cidrs</code></td>
<td><code>""</code></td>
<td></td>
</tr>
<tr>
<td><code>volume_type</code></td>
<td><code>gp2</code></td>
<td></td>
</tr>
<tr>
<td><code>working_dir</code></td>
<td><code>{{user `remote_folder`}}/worker</code></td>
<td>Directory path for ephemeral resources on the builder instance</td>
</tr>
</tbody>
</table>
<!-- template-variable-table-boundary -->

<hr />
<h2 id="choosing-kubernetes-binaries">Choosing Kubernetes binaries</h2>
<p>When building the AMI, binaries such as <code>kubelet</code>, <code>aws-iam-authenticator</code>, and <code>ecr-credential-provider</code> are installed.</p>
<h3 id="using-the-latest-binaries">Using the latest binaries</h3>
<p>It is recommended that the latest available binaries are used, as they may contain important fixes for bugs or security issues.
The latest binaries can be discovered with the following script:</p>
<pre><code class="language-bash">hack/latest-binaries.sh $KUBERNETES_MINOR_VERSION
</code></pre>
<p>This script will return the values for the binary-related AMI template variables, for example:</p>
<pre><code class="language-bash">&gt; hack/latest-binaries.sh 1.28

kubernetes_version=1.28.1 kubernetes_build_date=2023-10-01
</code></pre>
<h3 id="using-a-specific-version-of-the-binaries">Using a specific version of the binaries</h3>
<p>Use the following commands to obtain values for the binary-related AMI template variables:</p>
<pre><code class="language-bash"># List Kubernetes versions
aws s3 ls s3://amazon-eks

# List build dates
aws s3 ls s3://amazon-eks/1.23.9/

# List platforms
aws s3 ls s3://amazon-eks/1.23.9/2022-07-27/bin/

# List architectures
aws s3 ls s3://amazon-eks/1.23.9/2022-07-27/bin/linux/

# List binaries
aws s3 ls s3://amazon-eks/1.23.9/2022-07-27/bin/linux/x86_64/
</code></pre>
<p>To build using the example binaries above:</p>
<pre><code class="language-bash">make k8s \
  kubernetes_version=1.23.9 \
  kubernetes_build_date=2022-07-27 \
  arch=x86_64
</code></pre>
<h3 id="providing-your-own-binaries">Providing your own binaries</h3>
<p>By default, binaries are downloaded from the public S3 bucket <code>amazon-eks</code> in <code>us-west-2</code>.
You can instead provide your own version of Kubernetes binaries.</p>
<p>To use your own binaries:</p>
<ol>
<li>Copy all of the necessary binaries to your own S3 bucket using the AWS CLI. For example:</li>
</ol>
<pre><code class="language-bash"> aws s3 cp kubelet s3://$BUCKET/$KUBERNETES_VERSION/$KUBERNETES_BUILD_DATE/bin/linux/$ARCH/kubelet
</code></pre>
<p><strong>Important</strong>: You must provide all the binaries present in the default <code>amazon-eks</code> bucket for a specific <code>KUBERNETES_VERSION</code>, <code>KUBERNETES_BUILD_DATE</code>, and <code>ARCH</code> combination.
These binaries must be accessible using the credentials on the Packer builder EC2 instance.</p>
<ol>
<li>Run the following command to start the build process to use your own Kubernetes binaries:</li>
</ol>
<pre><code class="language-bash">make k8s \
  binary_bucket_name=my-custom-bucket \
  binary_bucket_region=eu-west-1 \
  kubernetes_version=1.14.9 \
  kubernetes_build_date=2020-01-22
</code></pre>
<p><strong>Note</strong>: Confirm that the binary_bucket_name, binary_bucket_region, kubernetes_version, and kubernetes_build_date parameters match the path to your binaries in Amazon S3.</p>
<hr />
<h2 id="container-image-caching">Container Image Caching</h2>
<p>Optionally, some container images can be cached during the AMI build process in order to reduce the latency of the node getting to a <code>Ready</code> state when launched.</p>
<p>To turn on container image caching:</p>
<pre><code>cache_container_images=true make 1.23
</code></pre>
<p>When container image caching is enabled, the following images are cached:
 - 602401143452.dkr.ecr.<AWS_REGION>.amazonaws.com/eks/kube-proxy:<default and latest>-eksbuild.<BUILD_VERSION>
 - 602401143452.dkr.ecr.<AWS_REGION>.amazonaws.com/eks/kube-proxy:<default and latest>-minimal-eksbuild.<BUILD_VERSION>
 - 602401143452.dkr.ecr.<AWS_REGION>.amazonaws.com/eks/pause:3.5
 - 602401143452.dkr.ecr.<AWS_REGION>.amazonaws.com/amazon-k8s-cni-init:<default and latest>
 - 602401143452.dkr.ecr.<AWS_REGION>.amazonaws.com/amazon-k8s-cni:<default and latest></p>
<p>The account ID can be different depending on the region and partition you are building the AMI in. See <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-ons-images.html">here</a> for more details.</p>
<p>Since the VPC CNI is not versioned with K8s itself, the latest version of the VPC CNI and the default version, based on the response from the EKS DescribeAddonVersions at the time of the AMI build, will be cached.</p>
<p>The images listed above are also tagged with each region in the partition the AMI is built in, since images are often built in one region and copied to others within the same partition. Images that are available to pull from an ECR FIPS endpoint are also tagged as such (i.e. <code>602401143452.dkr.ecr-fips.us-east-1.amazonaws.com/eks/pause:3.5</code>).</p>
<p>When listing images on a node, you'll notice a long list of images. However, most of these images are simply tagged in different ways with no storage overhead. Images cached in the AMI total around 1.0 GiB. In general, a node with no images cached using the VPC CNI will use around 500 MiB of images when in a <code>Ready</code> state with no other pods running on the node.</p>
<hr />
<h2 id="iam-permissions">IAM Permissions</h2>
<p>To build the EKS Optimized AMI, you will need the following permissions:</p>
<pre><code>{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;ec2:AttachVolume&quot;,
                &quot;ec2:AuthorizeSecurityGroupIngress&quot;,
                &quot;ec2:CopyImage&quot;,
                &quot;ec2:CreateImage&quot;,
                &quot;ec2:CreateKeypair&quot;,
                &quot;ec2:CreateSecurityGroup&quot;,
                &quot;ec2:CreateSnapshot&quot;,
                &quot;ec2:CreateTags&quot;,
                &quot;ec2:CreateVolume&quot;,
                &quot;ec2:DeleteKeyPair&quot;,
                &quot;ec2:DeleteSecurityGroup&quot;,
                &quot;ec2:DeleteSnapshot&quot;,
                &quot;ec2:DeleteVolume&quot;,
                &quot;ec2:DeregisterImage&quot;,
                &quot;ec2:DescribeImageAttribute&quot;,
                &quot;ec2:DescribeImages&quot;,
                &quot;ec2:DescribeInstances&quot;,
                &quot;ec2:DescribeInstanceStatus&quot;,
                &quot;ec2:DescribeRegions&quot;,
                &quot;ec2:DescribeSecurityGroups&quot;,
                &quot;ec2:DescribeSnapshots&quot;,
                &quot;ec2:DescribeSubnets&quot;,
                &quot;ec2:DescribeTags&quot;,
                &quot;ec2:DescribeVolumes&quot;,
                &quot;ec2:DetachVolume&quot;,
                &quot;ec2:GetPasswordData&quot;,
                &quot;ec2:ModifyImageAttribute&quot;,
                &quot;ec2:ModifyInstanceAttribute&quot;,
                &quot;ec2:ModifySnapshotAttribute&quot;,
                &quot;ec2:RegisterImage&quot;,
                &quot;ec2:RunInstances&quot;,
                &quot;ec2:StopInstances&quot;,
                &quot;ec2:TerminateInstances&quot;,
                &quot;eks:DescribeAddonVersions&quot;,
                &quot;ecr:GetAuthorizationToken&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;
        },
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;ecr:BatchGetImage&quot;,
                &quot;ecr:BatchCheckLayerAvailability&quot;,
                &quot;ecr:GetDownloadUrlForLayer&quot;
            ],
            &quot;Resource&quot;: &quot;arn:aws:ecr:us-west-2:602401143452:repository/*&quot;
        },
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;s3:GetObject&quot;
            ],
            &quot;Resource&quot;: &quot;arn:aws:s3:::amazon-eks/*&quot;
        }
    ]
}
</code></pre>
<p>You will need to use the region you are building the AMI in to specify the ECR repository resource in the second IAM statement. You may also need to change the account if you are building the AMI in a different partition or special region. You can see a mapping of regions to account ID <a href="https://docs.aws.amazon.com/eks/latest/userguide/add-ons-images.html">here</a>.
If you're using a custom s3 bucket to vend different K8s binaries, you will need to change the resource in the third IAM statement above to reference your custom bucket.
For more information about the permissions required by Packer with different configurations, see the <a href="https://www.packer.io/plugins/builders/amazon#iam-task-or-instance-role">docs</a>.</p>
<hr />
<h2 id="customizing-kubelet-config">Customizing Kubelet Config</h2>
<p>In some cases, customers may want to customize the <a href="https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration">kubelet configuration</a> on their nodes, and there are two mechanisms to do that with the EKS Optimized AMI.</p>
<p><strong>Set the "--kubelet-extra-args" flag when invoking bootstrap.sh</strong></p>
<p><code>bootstrap.sh</code>, the script that bootstraps nodes when using the EKS Optimized AMI, supports a flag called <code>--kubelet-extra-args</code> that allows you to pass in additional <code>kubelet</code> configuration. If you invoke the bootstrap script yourself (self-managed nodegroups or EKS managed nodegroups with custom AMIs), you can use that to customize your configuration. For example, you can use something like the following in your userdata:</p>
<pre><code>/etc/eks/bootstrap.sh my-cluster --kubelet-extra-args '--registry-qps=20 --registry-burst=40'
</code></pre>
<p>In this case, it will set <code>registryPullQPS</code> to 20 and <code>registryBurst</code> to 40 in <code>kubelet</code>. Some of the flags, like the ones above, are marked as deprecated and you're encouraged to set them in the <code>kubelet</code> config file (described below), but they continue to work as of 1.23.</p>
<p><strong>Update the kubelet config file</strong></p>
<p>You can update the <code>kubelet</code> config file directly with new configuration. On EKS Optimized AMIs, the file is stored at <code>/etc/kubernetes/kubelet/kubelet-config.json</code>. It must be valid JSON. You can use a utility like <code>jq</code> (or your tool of choice) to edit the config in your user data:</p>
<pre><code>echo &quot;$(jq &quot;.registryPullQPS=20 | .registryBurst=40&quot; /etc/kubernetes/kubelet/kubelet-config.json)&quot; &gt; /etc/kubernetes/kubelet/kubelet-config.json
</code></pre>
<p>There are a couple of important caveats here:</p>
<ol>
<li>If you update the <code>kubelet</code> config file after <code>kubelet</code> has already started (i.e. <code>bootstrap.sh</code> already ran), you'll need to restart <code>kubelet</code> to pick up the latest configuration.</li>
<li><a href="https://github.com/awslabs/amazon-eks-ami/blob/master/files/bootstrap.sh">bootstrap.sh</a> does modify a few fields, like <code>kubeReserved</code> and <code>evictionHard</code>, so you'd need to modify the config after the bootstrap script is run and restart <code>kubelet</code> to overwrite those properties.</li>
</ol>
<p><strong>View active kubelet config</strong></p>
<p>When <code>kubelet</code> starts up, it logs all possible flags, including unset flags. The unset flags get logged with default values. <em>These logs do not necessarily reflect the actual active configuration.</em> This has caused confusion in the past when customers have configured the <code>kubelet</code> config file with one value and notice the default value is logged. Here is an example of the referenced log:</p>
<pre><code>Aug 16 21:53:49 ip-192-168-92-220.us-east-2.compute.internal kubelet[3935]: I0816 21:53:49.202824    3935 flags.go:59] FLAG: --registry-burst=&quot;10&quot;
Aug 16 21:53:49 ip-192-168-92-220.us-east-2.compute.internal kubelet[3935]: I0816 21:53:49.202829    3935 flags.go:59] FLAG: --registry-qps=&quot;5&quot;
</code></pre>
<p>To view the actual <code>kubelet</code> config on your node, you can use the Kubernetes API to confirm that your configuration has applied.</p>
<pre><code>$ kubectl proxy
$ curl -sSL &quot;http://localhost:8001/api/v1/nodes/ip-192-168-92-220.us-east-2.compute.internal/proxy/configz&quot; | jq

{
  &quot;kubeletconfig&quot;: {
    ...
    &quot;registryPullQPS&quot;: 20,
    &quot;registryBurst&quot;: 40,
    ...
  }
}
</code></pre>
<hr />
<h2 id="al2-and-linux-kernel-information">AL2 and Linux Kernel Information</h2>
<p>By default, the <code>amazon-eks-ami</code> uses a <a href="https://github.com/awslabs/amazon-eks-ami/blob/e3f1b910f83ad1f27e68312e50474ea6059f052d/eks-worker-al2.json#L46">source_ami_filter</a> that selects the latest <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/virtualization_types.html">hvm</a> AL2 AMI for the given architecture as the base AMI. For more information on what kernel versions are running on published Amazon EKS optimized Linux AMIs, see <a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-linux-ami-versions.html">the public documentation</a>.</p>
<p>When building an AMI, you can set <code>kernel_version</code> to customize the kernel version. Valid values are:
- <code>4.14</code>
- <code>5.4</code>
- <code>5.10</code></p>
<p>If <code>kernel_version</code> is not set:
- For Kubernetes 1.23 and below, <code>5.4</code> is used.
- For Kubernetes 1.24 and above, <code>5.10</code> is used.</p>
<p>The <a href="https://github.com/awslabs/amazon-eks-ami/blob/master/scripts/upgrade_kernel.sh">upgrade_kernel.sh script</a> contains the logic for updating and upgrading the kernel.</p>
<hr />
<h2 id="updating-known-instance-types">Updating known instance types</h2>
<p><code>files/bootstrap.sh</code> configures the maximum number of pods on a node based off of the number of ENIs available, which is determined by the instance type. Larger instances generally have more ENIs. The number of ENIs limits how many IPV4 addresses are available on an instance, and we need one IP address per pod. You can <a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/scripts/gen_vpc_ip_limits.go">see this file</a> for the code that calculates the max pods for more information.</p>
<p>To add support for new instance types, at a minimum, we need to update <code>files/eni-max-pods.txt</code> using the <a href="https://github.com/aws/amazon-vpc-cni-k8s">amazon-vpc-cni-k8s package.</a> to set the number of max pods available for those instance types. If the instance type is not on the list, <code>bootstrap.sh</code> will fail when the node is started.</p>
<pre><code>$ git clone git@github.com:aws/amazon-vpc-cni-k8s.git

# AWS credentials required at this point
$ make generate-limits
# misc/eni-max-pods.txt should be generated

# Copy the generated file to this repo, something like this:
$ cp misc/eni-max-pods.txt ../amazon-eks-ami/files/

# Verify that expected types were added
$ git diff
</code></pre>
<p>At this point, you can build an AMI and it will include the updated list of instance types.</p>
<hr />
<h2 id="version-locked-packages">Version-locked packages</h2>
<p>Some packages are critical for correct, performant behavior of a Kubernetes node; such as:
- <code>kernel</code>
- <code>containerd</code>
- <code>runc</code></p>
<blockquote>
<p><strong>Note</strong>
This is not an exhaustive list. The complete list of locked packages is available with <code>yum versionlock list</code>.</p>
</blockquote>
<p>As a result, these packages should generally be modified within the bounds of a managed process that gracefully handles failures and prevents disruption to the cluster's workloads.</p>
<p>To prevent unintentional changes, the <a href="https://github.com/rpm-software-management/yum-utils/tree/05db7ef501fc9d6698935bcc039c83c0761c3be2/plugins/versionlock">yum-versionlock</a> plugin is used on these packages.</p>
<p>If you wish to modify a locked package, you can:</p>
<pre><code># unlock a single package
sudo yum versionlock delete $PACKAGE_NAME

# unlock all packages
sudo yum versionlock clear
</code></pre>
<hr />
<h2 id="image-credential-provider-plugins">Image credential provider plugins</h2>
<p>Prior to Kubernetes 1.27, the <code>kubelet</code> could obtain credentials for ECR out of the box. This legacy credential process has been removed in Kubernetes 1.27, and
ECR credentials should now be obtained via a plugin, the <code>ecr-credential-provider</code>. This plugin is installed in the AMI at <code>/etc/eks/image-credential-provider/ecr-credential-provider</code>. More information about this plugin is available in the <a href="https://cloud-provider-aws.sigs.k8s.io/credential_provider/"><code>cloud-provider-aws</code> documentation</a>.</p>
<p>Additional image credential provider plugins may be appended to <code>/etc/eks/image-credential-provider/config.json</code>. In Kubernetes versions 1.26 and below, all plugins in this file must support <code>credentialprovider.kubelet.k8s.io/v1alpha1</code>. In Kubernetes versions 1.27 and above, they must support <code>credentialprovider.kubelet.k8s.io/v1</code>.</p>
<p>For more information about image credential provider plugins, refer to the <a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-credential-provider/">Kubernetes documentation</a>.</p>
<hr />
<h2 id="ephemeral-storage">Ephemeral Storage</h2>
<p>Some instance types launch with ephemeral NVMe instance storage (i3, i4i, c5d, c6id, etc). There are two main ways of utilizing this storage within Kubernetes: a single RAID-0 array for use by kubelet and containerd or mounting the individual disks for pod usage.</p>
<p>The EKS Optimized AMI includes a utility script to configure ephemeral storage. The script can be invoked by passing the <code>--local-disks &lt;raid0 | mount&gt;</code> flag to the <code>/etc/eks/bootstrap.sh</code> script or the script can be invoked directly at <code>/bin/setup-local-disks</code>. All disks are formatted with an XFS file system.</p>
<p>Below are details on the two disk setup options:</p>
<h3 id="raid-0-for-kubelet-and-containerd-raid0">RAID-0 for Kubelet and Containerd (raid0)</h3>
<p>A RAID-0 array is setup that includes all ephemeral NVMe instance storage disks. The containerd and kubelet state directories (<code>/var/lib/containerd</code> and <code>/var/lib/kubelet</code>) will then use the ephemeral storage for more and faster node ephemeral-storage. The node's ephemeral storage can be shared among pods that request ephemeral storage and container images that are downloaded to the node.</p>
<h3 id="mount-for-persistent-volumes-mount">Mount for Persistent Volumes (mount)</h3>
<p>Another way of utilizing the ephemeral disks is to format and mount the individual disks. Mounting individual disks allows the <a href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner">local-static-provisioner</a> DaemonSet to create Persistent Volume Claims that pods can utilize.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.8fd75fb4.min.js"></script>
      
    
  </body>
</html>